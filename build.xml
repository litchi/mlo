<project default="run-unit-test" basedir=".">
    <target name="help">
        <echo>Run [ant deploy-ws] to deploy to remote server</echo>
        <echo>Run [ant deploy-bb] to deploy to blackberry 10 simulator</echo>
        <echo>Run [ant run-unit-test] to run unit tests for javascript</echo>
        <echo>Run [ant clean] to clean target directory</echo>
    </target>
    <property name = "build.production.src"        location = "."/>
    <property name = "build.production.target"     location = "../target"/>
    <property name = "build.remote.ip"             value    = "172.16.177.134"/>

    <!-- This is set to local file for development -->
    <property name = "build.test.runner.url"       value    = "./js/spec/SpecRunner.html"/>

    <!-- Please notice that by using open we are using the default browser defined by current OS user-->
    <property name = "env.browser.executable"      value    = "open"/>

    <target name="init">
        <mkdir dir="${build.production.target}"/>
    </target>

    <target name="pre.process.copy" depends="init">
        <loadfile property="actionbar.content" srcFile="${build.production.src}/elements/actionbar.html"/>
        <loadfile property="task.context.menu.content" srcFile="${build.production.src}/elements/task-context-menu.html"/>
        <loadfile property="task.create.inputbox" srcFile="${build.production.src}/elements/create-task-input.html"/>
        <copy todir="${build.production.target}" encoding="UTF-8" outputencoding="UTF-8">
            <fileset dir="${build.production.src}">
                <exclude name="**/*.swp"/>
                <exclude name=".git"/>
                <exclude name="**/*.bak"/>
                <exclude name="build.xml"/>
                <exclude name=".idea/**/*.*"/>
                <exclude name="**/*.html"/>
                <exclude name="elements"/>

                <!--Exclude jasmine libs for unit testing-->
                <exclude name="js/libs/jasmine-1.3.1"/>
                <exclude name="js/libs/jasmine-1.3.1/*.*"/>

                <!--Exclude testing specs-->
                <exclude name="js/spec"/>
                <exclude name="js/spec/*.*"/>
            </fileset>
        </copy>

        <!-- HTML files are always copied since the markups in those files needs to be replaced by element fragments everytime -->
        <copy todir="${build.production.target}" encoding="UTF-8" outputencoding="UTF-8" verbose="false" granularity="1" overwrite="true">
            <fileset dir="${build.production.src}">
                <exclude name="elements"/>
                <exclude name="elements/*.html"/>
                <include name="**/*.html"/>
            </fileset>
            <filterset begintoken="@" endtoken="@">
                <filter token = "actionbar"            value = "${actionbar.content}"/>
                <filter token = "task-context-menu"    value = "${task.context.menu.content}"/>
                <filter token = "task-create-inputbox" value = "${task.create.inputbox}"/>
            </filterset>
        </copy>
    </target>

    <target name="deploy-ws" depends="pre.process.copy">
        <scp todir="root:password@${build.remote.ip}:/var/www/gtd">
            <fileset dir="${build.production.target}" excludes="**/*.swp,.git,**/*.bak,.DS_Store"/>
        </scp>                 
    </target>

    <target name="run-unit-test" depends="pre.process.copy">
        <exec executable="${env.browser.executable}" spawn="yes"> 
            <arg value="${build.test.runner.url}"/> 
        </exec> 
    </target>

    <target name="deploy-bb" depends="pre.process.copy">
        <exec executable="/bin/sh">
            <arg line='-c "bb_launch.sh target"'/>
        </exec>
    </target>

    <target name="clean">
        <delete dir="${build.production.target}"/>
    </target>
</project>
